{% extends "::layout/layout.html.twig" %}
{% block titre %} Pascalp Version Développement > Produits dans le panier {% endblock %}
{% set totalHT = 0 %}
{% set totalTTC = 0 %}
{% set refTva = {} %}
{% for produit in produits %}
    {# on crée un tableau qui va ajouter à la liste les taux de tva différents : #}
    {% set refTva = refTva|merge({ ('%' ~produit.tva.valeur) : 0 }) %}   
{% endfor %}
{% block body %}
<div class="container">
    <div class="row">
        <div class="col-xs-1">
            <button type="button" class="btn btn-default navbar-nontoggle toggle-sidebar">

                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
            </button>
        </div> 
        <div class="col-xs-11">{% render(controller('EcomBundle:Panier:menupanier')) %}
        </div>
    </div>
    <div class="wedge5"> &nbsp; </div>   
    <div class="row" id="row-main">
        <div class="col-md-2 " id="sidebar">  
            {% include '::modulesBase/nav.html.twig' %}
            {% if is_granted('IS_AUTHENTICATED_FULLY') %}
                {% include 'UtilisateursBundle:Default:modulesUsed/utilisateursConnected.html.twig' %}  
            {% else %}
                {% include 'UtilisateursBundle:Default:modulesUsed/utilisateurs.html.twig' %}  
            {% endif %}
        </div> 
        <div class="col-md-12" id="content"> 
            {% for flashMessage in app.session.flashbag.get('success') %}
                <div class="alert alert-success">{{flashMessage}}</div>
            {% endfor %}
        	<h2>Votre panier</h2>
        		<table class="table table-striped table-hover">
        			<thead>
        				<tr>
                            <th></th>
        					<th>Références</th>
        					<th>Quantité</th>
        					<th>Prix unitaire HT</th>
                            <th>Prix unitaire TTC</th>
        					<th>Total HT</th>
                            <th>Total TTC</th>
        				</tr>
        			</thead>
        			<tbody>
                        {% if produits|length == 0 %}
                            <tr><td colspan="4" style="text-align:center">Aucun article dans votre panier</td></tr>
                        {% endif %}
                        
                        {% for produit in produits %}
        				<tr>
                            <form action="{{path('ajoutpanier2',{'id': produit.id})  }}" method="get">
                            <td><img src="{{ produit.image.AssetPath|imagine_filter('imgProduitFormat0')}}" alt="image {{ produit.image.name }}" title="{{produit.image.name}}" width="40px" ></td>
        					<td>{{produit.nom}}</td>
        					<td>
        						<select name="qte" class="col-sm-8" onChange="this.form.submit()">
                                    {% for i in 0..10 %}
                                    <option value="{{i}}" {% if i == panier[produit.id] %} selected="selected" {% endif %} >{{ i }}</option>
                                    {% endfor %}
                                </select>&nbsp;
        						<a href="{{path('supprimer', {'id':produit.id }) }}"><i class="glyphicon glyphicon-trash"></i></a>       						
        					</td>
        					<td>{{produit.prix |number_format(2)}} €</td><td>{{produit.prix|tva(produit.tva.multiplicate)|number_format(2)}} €</td>
        					<td>{{(produit.prix * panier[produit.id] )|number_format(2)}} €</td> 
                            <td>{{((produit.prix|tva(produit.tva.multiplicate)) * panier[produit.id] )|number_format(2)}} €</td> 
                            </form>      					
        				</tr>
                         {% set totalHT = totalHT + (produit.prix*panier[produit.id] ) %}
                         {% set totalTTC = totalTTC + ((produit.prix * panier[produit.id])|tva(produit.tva.multiplicate)) %}
                         {% set refTva = refTva|merge({ ('%' ~produit.tva.valeur) : refTva['%' ~produit.tva.valeur] + ( produit.prix * panier[produit.id]) |montantTva(produit.tva.multiplicate) }) %}
                        {% endfor %}
        			</tbody>
        		</table>
            {% if produits|length != 0 %}
            	<dl class="dl-horizontal pull-right">
            		<dt>Total HT :</dt> <dd>{{totalHT|number_format(2)}}€</dd>
                    {% for key, tva in refTva %}
            		  <dt>TVA {{key}} :</dt> <dd>{{ tva |number_format(2)}}€</dd>
                    {% endfor %}
            		<dt>Total TTC :</dt> <dd>{{totalTTC|number_format(2)}}€</dd>
            	</dl>
            {% endif %}
        	<div class="clearfix"></div>
            {% if produits|length != 0 %}
        	<a href="{{path ('adresses')}}" class="btn btn-success pull-right">Valider mon panier</a>
            {% endif %}
        	<a href="{{path ('produits')}}" class="btn btn-primary ">Continuer mes achats</a>
        </div>
    </div>
</div>
{% endblock %}