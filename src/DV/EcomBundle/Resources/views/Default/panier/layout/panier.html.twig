{% extends "::layout/layout.html.twig" %}
{% set totalHT = 0 %}
{% set totalTTC = 0 %}
{% set refTva = {} %}
{% for produit in produits %}
    {# on crée un tableau qui va ajouter à la liste les taux de tva différents : #}
    {% set refTva = refTva|merge({ ('%' ~produit.tva.valeur) : 0 }) %}   
{% endfor %}
{% block body %}
<div class="container">
    <div class="row">
    <div class="col-xs-1">
     <button type="button" class="btn btn-default toggle-sidebar"><span class="h3">&#8801; </span></button>
    </div> 
    <div class="col-xs-11">
     {% include 'EcomBundle:Default:panier/modulesUsed/menupanier.html.twig' %}   
    </div>
    </div>
    <div class="wedge5"> &nbsp; </div>   
    <div class="row" id="row-main">
        <div class="col-md-2" id="sidebar">  
            {% include '::modulesBase/nav.html.twig' %}
        </div> 
        <div class="col-md-10" id="content"> 
            {% for flashMessage in app.session.flashbag.get('success') %}
                <div class="alert alert-success">{{flashMessage}}</div>
            {% endfor %}
        	<h2>Votre panier</h2>
        		<table class="table table-striped table-hover">
        			<thead>
        				<tr>
        					<th>Références</th>
        					<th>Quantité</th>
        					<th>Prix unitaire HT</th>
        					<th>Total HT</th>
        				</tr>
        			</thead>
        			<tbody>
                        {% if produits|length == 0 %}
                            <tr><td colspan="4" style="text-align:center">Aucun article dans votre panier</td></tr>
                        {% endif %}
                        
                        {% for produit in produits %}
        				<tr>
                            <form action="{{path('ajoutpanier2',{'id': produit.id})  }}" method="get">
        					<td>{{produit.nom}}</td>
        					<td>
        						<select name="qte" class="col-sm-4" onChange="this.form.submit()">
                                    {% for i in 0..10 %}
                                    <option value="{{i}}" {% if i == panier[produit.id] %} selected="selected" {% endif %} >{{ i }}</option>
                                    {% endfor %}
                                </select>&nbsp;
        						<a href="{{path('supprimer', {'id':produit.id }) }}"><i class="glyphicon glyphicon-trash"></i></a>       						
        					</td>
        					<td>{{produit.prix}} €</td>
        					<td>{{produit.prix * panier[produit.id] }} €</td>  
                            </form>      					
        				</tr>
                         {% set totalHT = totalHT + (produit.prix*panier[produit.id] ) %}
                         {% set totalTTC = totalTTC + ((produit.prix * panier[produit.id])|tva(produit.tva.multiplicate)) %}
                         {% set refTva = refTva|merge({ ('%' ~produit.tva.valeur) : refTva['%' ~produit.tva.valeur] + ( produit.prix * panier[produit.id]) |montantTva(produit.tva.multiplicate) }) %}
                        {% endfor %}
        			</tbody>
        		</table>
            {% if produits|length != 0 %}
            	<dl class="dl-horizontal pull-right">
            		<dt>Total HT :</dt> <dd>{{totalHT}}€</dd>
                    {% for key, tva in refTva %}
            		  <dt>TVA {{key}} :</dt> <dd>{{ tva }}€</dd>
                    {% endfor %}
            		<dt>Total TTC :</dt> <dd>{{totalTTC}}€</dd>
            	</dl>
            {% endif %}
        	<div class="clearfix"></div>
            {% if produits|length != 0 %}
        	<a href="{{path ('adresses')}}" class="btn btn-success pull-right">Valider mon panier</a>
            {% endif %}
        	<a href="{{path ('produits')}}" class="btn btn-primary ">Continuer mes achats</a>
        </div>
    </div>
</div>
{% endblock %}